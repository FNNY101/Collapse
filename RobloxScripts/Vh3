-- Load MacLib from the demo (new GUI)
local MacLib = loadstring(game:HttpGet("https://github.com/biggaboy212/Maclib/releases/latest/download/maclib.txt"))()

-- Create the main window using MacLib (GUI size set to 800x500)
local Window = MacLib:Window({
	Title = "Collapse | Vh3",
	Subtitle = "| Made by Finny <3",
	Size = UDim2.fromOffset(800, 500),
	DragStyle = 2,
	DisabledWindowControls = {},
	ShowUserInfo = true,
	Keybind = Enum.KeyCode.RightControl,
	AcrylicBlur = false,
})

local globalSettings = {
	UIBlurToggle = Window:GlobalSetting({
		Name = "UI Blur",
		Default = Window:GetAcrylicBlurState(),
		Callback = function(bool)
			Window:SetAcrylicBlurState(bool)
			Window:Notify({
				Title = Window.Settings.Title,
				Description = (bool and "Enabled" or "Disabled") .. " UI Blur",
				Lifetime = 5
			})
		end,
	}),
	NotificationToggler = Window:GlobalSetting({
		Name = "Notifications",
		Default = Window:GetNotificationsState(),
		Callback = function(bool)
			Window:SetNotificationsState(bool)
			Window:Notify({
				Title = Window.Settings.Title,
				Description = (bool and "Enabled" or "Disabled") .. " Notifications",
				Lifetime = 5
			})
		end,
	}),
	ShowUserInfo = Window:GlobalSetting({
		Name = "Show User Info",
		Default = Window:GetUserInfoState(),
		Callback = function(bool)
			Window:SetUserInfoState(bool)
			Window:Notify({
				Title = Window.Settings.Title,
				Description = (bool and "Showing" or "Redacted") .. " User Info",
				Lifetime = 5
			})
		end,
	})
}

-- Create Tab Groups
local tabGroups = {
	Aim = Window:TabGroup(),
	World = Window:TabGroup(),
	Other = Window:TabGroup()
}

-- Create Tabs (Removed extra Configs tab; only "Settings" remains)
local tabs = {
	AimAssist = tabGroups.Aim:Tab({ Name = "Aim Assist", Image = "rbxassetid://99275039709063" }),
	Visuals = tabGroups.World:Tab({ Name = "Visuals", Image = "rbxassetid://104811813262009" }),
	Settings = tabGroups.Other:Tab({ Name = "Settings", Image = "rbxassetid://110807522910450" })
}

tabs.Settings:InsertConfigSection("Left")

--------------------------------------------
-- Existing Game Services and Variables  --
--------------------------------------------
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local CurrentCamera = game:GetService("Workspace").CurrentCamera
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Current Tracer Position and Aim Variables
local currentTracerPosition = "Bottom"  -- default tracer position
local Aiming = false
local currentTarget = nil

-- ESP Table (Box size remains dynamic; thickness is forced to 1)
local ESP = {
    Enabled = true,
    Box = {
        Enabled = false,
        Color = Color3.fromRGB(255, 255, 255),  -- white (forced)
        Thickness = 1, -- fixed thickness
        Outlines = true,
        OutlineThickness = 0
    },
    Tool = {
        Enabled = false,
        Color = Color3.fromRGB(255, 255, 255)
    },
    Distance = {
        Enabled = false,
        Color = Color3.fromRGB(255, 255, 255)
    },
    Tracers = {
        Enabled = false,
        Color = Color3.fromRGB(255, 255, 255),  -- forced white
        Thickness = 1, -- fixed thickness
        Outlines = true,
        OutlineThickness = 0
    },
    HealthBar = {
        Enabled = false,
        Color = Color3.fromRGB(0, 255, 0),
        Outlines = true,
        ShowNumber = true,
        NumberColor = Color3.fromRGB(255, 255, 255)
    }
}

-- Aim Settings (global)
getgenv().aim_settings = {
    enabled = false,
    fov = 150,
    hitbox = "Head",  -- default target is head
    fovcircle = false, -- FOV circle toggle is off by default
    aimKey = Enum.KeyCode.E
}
-- Local variable to always track the current aim key.
local currentAimKey = getgenv().aim_settings.aimKey

-- Create a single FOV Circle (follows the mouse; uses the same fov value)
local Circle = Drawing.new("Circle")
Circle.Visible = false
Circle.Thickness = 1
Circle.Color = Color3.fromRGB(255, 255, 255)
Circle.Transparency = 0.5
Circle.Filled = false
Circle.NumSides = 64

---------------------------
-- Aiming Functionality  --
---------------------------
local function AimLock()
    local mousePos = UserInputService:GetMouseLocation()
    
    if currentTarget and currentTarget.Character then
        local targetPart = currentTarget.Character:FindFirstChild(getgenv().aim_settings.hitbox)
        if targetPart then
            local screenPos, onScreen = CurrentCamera:WorldToViewportPoint(targetPart.Position)
            local screenPosition = Vector2.new(screenPos.X, screenPos.Y)
            local distance = (mousePos - screenPosition).Magnitude
            
            if onScreen and distance <= getgenv().aim_settings.fov then
                local pos = CurrentCamera.CFrame.Position
                CurrentCamera.CFrame = CFrame.new(pos, targetPart.Position)
                return
            end
        end
    end

    currentTarget = nil
    local lastMagnitude = math.huge
    
    for _, v in pairs(Players:GetPlayers()) do
        if v ~= LocalPlayer and v.Character then
            local targetPart = v.Character:FindFirstChild(getgenv().aim_settings.hitbox)
            if targetPart then
                local screenPos, onScreen = CurrentCamera:WorldToViewportPoint(targetPart.Position)
                local screenPosition = Vector2.new(screenPos.X, screenPos.Y)
                local distance = (mousePos - screenPosition).Magnitude
                
                if onScreen and distance <= getgenv().aim_settings.fov then
                    if distance < lastMagnitude then
                        lastMagnitude = distance
                        currentTarget = v
                    end
                end
            end
        end
    end
    
    if currentTarget and currentTarget.Character then
        local targetPart = currentTarget.Character:FindFirstChild(getgenv().aim_settings.hitbox)
        if targetPart then
            local pos = CurrentCamera.CFrame.Position
            CurrentCamera.CFrame = CFrame.new(pos, targetPart.Position)
        end
    end
end

------------------
-- ESP Functions --
------------------
local Functions = {}
do 
    function Functions:IsAlive(Player)
        if Player and Player.Character and Player.Character:FindFirstChild("Head") and Player.Character:FindFirstChild("Humanoid") and Player.Character.Humanoid.Health > 0 then
            return true
        end
        return false
    end
    
    function Functions:GetEquippedTool(Player)
        if Player and Player.Character then
            local Tool = Player.Character:FindFirstChildOfClass("Tool")
            if Tool then
                return Tool.Name
            end
        end
        return "None"
    end
    
    function Functions:GetDistance(Player)
        if Player and Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            return math.floor((Player.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude)
        end
        return 0
    end
end

--------------------
-- ESP Rendering  --
--------------------
do
    local function AddESP(Player)
        local BoxOutline = Drawing.new("Square")
        local Box = Drawing.new("Square")
        local TracerOutline = Drawing.new("Line")
        local Tracer = Drawing.new("Line")
        local HealthBarOutline = Drawing.new("Square")
        local HealthBar = Drawing.new("Square")
        local ToolText = Drawing.new("Text")
        local DistanceText = Drawing.new("Text")
        local HealthText = Drawing.new("Text") -- Health Number Text
        local Connection

        Box.Filled = false
        HealthBarOutline.Filled = false
        HealthBarOutline.Color = Color3.fromRGB(0, 0, 0)
        HealthBar.Filled = true
        HealthBar.ZIndex = 5

        HealthText.Size = 13
        HealthText.Center = true
        HealthText.Outline = true
        HealthText.Font = 2
        HealthText.Color = ESP.HealthBar.NumberColor

        ToolText.Size = 13
        ToolText.Center = true
        ToolText.Outline = true
        ToolText.Font = 2
        ToolText.Color = ESP.Tool.Color

        DistanceText.Size = 13
        DistanceText.Center = true
        DistanceText.Outline = true
        DistanceText.Font = 2
        DistanceText.Color = ESP.Distance.Color

        local function HideESP()
            BoxOutline.Visible = false
            Box.Visible = false
            TracerOutline.Visible = false
            Tracer.Visible = false
            HealthBarOutline.Visible = false
            HealthBar.Visible = false
            ToolText.Visible = false
            DistanceText.Visible = false
            HealthText.Visible = false
        end

        local function DestroyESP()
            BoxOutline:Remove()
            Box:Remove()
            TracerOutline:Remove()
            Tracer:Remove()
            HealthBarOutline:Remove()
            HealthBar:Remove()
            ToolText:Remove()
            DistanceText:Remove()
            HealthText:Remove()
            if Connection then Connection:Disconnect() end
        end

        Connection = RunService.RenderStepped:Connect(function()
            if not ESP.Enabled then 
                return HideESP()
            end

            if not Player or not Player.Parent then
                return DestroyESP()
            end

            if not Functions:IsAlive(Player) then
                return HideESP()
            end

            local HumanoidRootPart = Player.Character.HumanoidRootPart
            if not HumanoidRootPart then
                return HideESP()
            end

            local ScreenPosition, OnScreen = CurrentCamera:WorldToViewportPoint(HumanoidRootPart.Position)
            if not OnScreen then
                return HideESP()
            end

            local FrustumHeight = math.tan(math.rad(CurrentCamera.FieldOfView * 0.5)) * 2 * ScreenPosition.Z
            local Size = CurrentCamera.ViewportSize.Y / FrustumHeight * Vector2.new(5,6)
            local Position = Vector2.new(ScreenPosition.X, ScreenPosition.Y) - Size / 2

            if ESP.Box.Enabled then
                -- Force the box ESP colors to white
                BoxOutline.Color = Color3.new(1, 1, 1)
                Box.Color = Color3.new(1, 1, 1)
                BoxOutline.Visible = ESP.Box.Outlines
                BoxOutline.Thickness = ESP.Box.Thickness + ESP.Box.OutlineThickness
                BoxOutline.Position = Position
                BoxOutline.Size = Size

                Box.Visible = true
                Box.Position = Position
                Box.Size = Size
                Box.Thickness = ESP.Box.Thickness
            else
                Box.Visible = false
                BoxOutline.Visible = false
            end

            if ESP.Tool.Enabled then
                ToolText.Visible = true
                ToolText.Text = Functions:GetEquippedTool(Player)
                ToolText.Position = Vector2.new(Position.X + (Size.X / 2), Position.Y + Size.Y + 2)
                ToolText.Color = ESP.Tool.Color
            else
                ToolText.Visible = false
            end

            if ESP.Distance.Enabled then
                DistanceText.Visible = true
                DistanceText.Text = tostring(Functions:GetDistance(Player)) .. " studs"
                DistanceText.Position = Vector2.new(Position.X + (Size.X / 2), Position.Y - 15)
                DistanceText.Color = ESP.Distance.Color
            else
                DistanceText.Visible = false
            end

            if ESP.Tracers.Enabled then
                local tracerFrom
                if currentTracerPosition == "Bottom" then
                    tracerFrom = Vector2.new(CurrentCamera.ViewportSize.X / 2, CurrentCamera.ViewportSize.Y)
                elseif currentTracerPosition == "Middle" then
                    tracerFrom = Vector2.new(CurrentCamera.ViewportSize.X / 2, CurrentCamera.ViewportSize.Y / 2)
                elseif currentTracerPosition == "Top" then
                    tracerFrom = Vector2.new(CurrentCamera.ViewportSize.X / 2, 0)
                elseif currentTracerPosition == "Mouse" then
                    tracerFrom = UserInputService:GetMouseLocation()
                end

                -- Force tracer colors to white
                TracerOutline.Color = Color3.new(1, 1, 1)
                TracerOutline.Visible = ESP.Tracers.Outlines
                TracerOutline.Thickness = ESP.Tracers.Thickness + ESP.Tracers.OutlineThickness
                TracerOutline.From = tracerFrom
                TracerOutline.To = Vector2.new(ScreenPosition.X, Position.Y + Size.Y)

                Tracer.Visible = true
                Tracer.Color = Color3.new(1, 1, 1)
                Tracer.Thickness = ESP.Tracers.Thickness
                Tracer.From = tracerFrom
                Tracer.To = Vector2.new(TracerOutline.To.X, TracerOutline.To.Y)
            else
                TracerOutline.Visible = false
                Tracer.Visible = false
            end

            if ESP.HealthBar.Enabled then
                local health = Player.Character.Humanoid.Health
                local maxHealth = Player.Character.Humanoid.MaxHealth
                local healthPercent = health / maxHealth

                HealthBarOutline.Visible = ESP.HealthBar.Outlines
                HealthBarOutline.Position = Vector2.new(Position.X - 6, Position.Y + Size.Y)
                HealthBarOutline.Size = Vector2.new(3, -Size.Y * healthPercent)
                HealthBarOutline.Thickness = 1

                HealthBar.Visible = true
                HealthBar.Position = HealthBarOutline.Position
                HealthBar.Size = HealthBarOutline.Size
                HealthBar.Color = ESP.HealthBar.Color

                HealthText.Visible = ESP.HealthBar.ShowNumber
                HealthText.Text = tostring(math.floor(health))
                HealthText.Position = Vector2.new(Position.X - 4.5, Position.Y + Size.Y - (Size.Y * healthPercent) - 15)
            else
                HealthBarOutline.Visible = false
                HealthBar.Visible = false
                HealthText.Visible = false
            end
        end)
    end

    for i, v in pairs(Players:GetPlayers()) do 
        if v ~= LocalPlayer then
            AddESP(v)
        end
    end

    Players.PlayerAdded:Connect(function(v)
        AddESP(v)
    end)
end

---------------------------
-- FOV Circle & Aim Loop  --
---------------------------
RunService.RenderStepped:Connect(function()
    -- Aimbot only runs when enabled and key is held
    if getgenv().aim_settings.enabled and Aiming then
        AimLock()
    end
    
    -- FOV Circle uses the same fov value; its visibility is independent
    Circle.Position = UserInputService:GetMouseLocation()
    Circle.Radius = getgenv().aim_settings.fov
    Circle.Visible = getgenv().aim_settings.fovcircle
end)

--------------------------
-- Input Event Listeners for Aimbot --
--------------------------
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	-- Check for both keyboard and mouse input types against the current aim key.
	if (input.KeyCode and input.KeyCode == currentAimKey) or (input.UserInputType and input.UserInputType == currentAimKey) then
		Aiming = true
	end
end)

UserInputService.InputEnded:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	-- When the aim key is released, disable aiming.
	if (input.KeyCode and input.KeyCode == currentAimKey) or (input.UserInputType and input.UserInputType == currentAimKey) then
		Aiming = false
		currentTarget = nil
	end
end)

--------------------------
-- GUI: Aim Assist Tab  --
--------------------------
local aimSection = tabs.AimAssist:Section({ Side = "Left" })

aimSection:Toggle({
	Name = "Aim Assist",
	Default = false,
	Callback = function(Value)
		getgenv().aim_settings.enabled = Value
		if not Value then
			Aiming = false
			currentTarget = nil
		end
		-- No notification here.
	end,
}, "AimAssistToggle")

aimSection:Keybind({
	Name = "Aim Key",
	Default = currentAimKey,
	Callback = function(binded)
		-- Update both the global setting and our local currentAimKey variable without sending a notification.
		getgenv().aim_settings.aimKey = binded
		currentAimKey = binded
	end,
	onBinded = function(bind)
		-- No notification here.
		getgenv().aim_settings.aimKey = bind
		currentAimKey = bind
	end,
	onBindHeld = function()
		return Aiming, currentAimKey
	end,
}, "AimKey")

aimSection:Toggle({
	Name = "FOV Circle",
	Default = false,  -- FOV Circle off by default
	Callback = function(Value)
		getgenv().aim_settings.fovcircle = Value
		-- No notification here.
	end,
}, "FOVCircleToggle")

aimSection:Slider({
	Name = "FOV Size",
	Default = getgenv().aim_settings.fov,
	Minimum = 1,
	Maximum = 800,
	DisplayMethod = "Value",
	Precision = 0,
	Callback = function(Value)
		getgenv().aim_settings.fov = Value
		Window:Notify({
			Title = "FOV Size",
			Description = "FOV size set to: " .. tostring(Value),
			Lifetime = 5
		})
	end,
}, "FOVSizeSlider")

aimSection:Dropdown({
	Name = "Aim Target",
	Multi = false,
	Required = true,
	Search = true,
	Default = "Head",
	Options = {"Head", "HumanoidRootPart"},
	Callback = function(Value)
		getgenv().aim_settings.hitbox = Value
		Window:Notify({
			Title = "Aim Target",
			Description = "Target set to: " .. tostring(Value),
			Lifetime = 5
		})
	end,
}, "AimTargetDropdown")

----------------------------
-- GUI: Visuals (ESP) Tab --
----------------------------
local visualsSection = tabs.Visuals:Section({ Side = "Left" })

visualsSection:Toggle({
	Name = "Box ESP",
	Default = false,
	Callback = function(Value)
		ESP.Box.Enabled = Value
		Window:Notify({
			Title = "Box ESP",
			Description = (Value and "Enabled" or "Disabled"),
			Lifetime = 5
		})
	end,
}, "BoxESPToggle")

visualsSection:Toggle({
	Name = "Tracers",
	Default = false,
	Callback = function(Value)
		ESP.Tracers.Enabled = Value
		Window:Notify({
			Title = "Tracers",
			Description = (Value and "Enabled" or "Disabled"),
			Lifetime = 5
		})
	end,
}, "TracersToggle")

visualsSection:Dropdown({
	Name = "Tracer Position",
	Multi = false,
	Required = true,
	Search = true,
	Default = "Bottom",
	Options = {"Bottom", "Middle", "Top", "Mouse"},
	Callback = function(Value)
		currentTracerPosition = Value
	end,
}, "TracerPositionDropdown")

visualsSection:Toggle({
	Name = "Healthbar",
	Default = false,
	Callback = function(Value)
		ESP.HealthBar.Enabled = Value
		ESP.HealthBar.ShowNumber = Value
		Window:Notify({
			Title = "Healthbar",
			Description = (Value and "Enabled" or "Disabled"),
			Lifetime = 5
		})
	end,
}, "HealthbarToggle")

visualsSection:Toggle({
	Name = "Tool ESP",
	Default = false,
	Callback = function(Value)
		ESP.Tool.Enabled = Value
		Window:Notify({
			Title = "Tool ESP",
			Description = (Value and "Enabled" or "Disabled"),
			Lifetime = 5
		})
	end,
}, "ToolESPToggle")

visualsSection:Toggle({
	Name = "Distance ESP",
	Default = false,
	Callback = function(Value)
		ESP.Distance.Enabled = Value
		Window:Notify({
			Title = "Distance ESP",
			Description = (Value and "Enabled" or "Disabled"),
			Lifetime = 5
		})
	end,
}, "DistanceESPToggle")

---------------------
-- Finalize GUI  --
---------------------
tabs.AimAssist:Select()

Window:Notify({
	Title = "Collapse:Vampire Hunters",
	Description = "Script loaded successfully! - Made by Finny <3",
	Lifetime = 5
})
